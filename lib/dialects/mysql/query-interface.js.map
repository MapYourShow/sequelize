{
  "version": 3,
  "sources": ["../../../src/dialects/mysql/query-interface.js"],
  "sourcesContent": ["'use strict';\r\n\r\nimport { assertNoReservedBind, combineBinds } from '../../utils/sql';\r\n\r\nconst sequelizeErrors = require('../../errors');\r\nconst { QueryInterface } = require('../abstract/query-interface');\r\nconst { QueryTypes } = require('../../query-types');\r\n\r\n/**\r\n * The interface that Sequelize uses to talk with MySQL/MariaDB database\r\n */\r\nexport class MySqlQueryInterface extends QueryInterface {\r\n  /**\r\n   * A wrapper that fixes MySQL's inability to cleanly remove columns from existing tables if they have a foreign key constraint.\r\n   *\r\n   * @override\r\n   */\r\n  async removeColumn(tableName, columnName, options) {\r\n    options = options || {};\r\n\r\n    const [results] = await this.sequelize.queryRaw(\r\n      this.queryGenerator.getForeignKeyQuery(tableName.tableName ? tableName : {\r\n        tableName,\r\n        schema: this.sequelize.config.database,\r\n      }, columnName),\r\n      { raw: true, ...options },\r\n    );\r\n\r\n    // Exclude primary key constraint\r\n    if (results.length > 0 && results[0].constraint_name !== 'PRIMARY') {\r\n      await Promise.all(results.map(constraint => this.sequelize.queryRaw(\r\n        this.queryGenerator.dropForeignKeyQuery(tableName, constraint.constraint_name),\r\n        { raw: true, ...options },\r\n      )));\r\n    }\r\n\r\n    return await this.sequelize.queryRaw(\r\n      this.queryGenerator.removeColumnQuery(tableName, columnName),\r\n      { raw: true, ...options },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  async upsert(tableName, insertValues, updateValues, where, options) {\r\n    if (options.bind) {\r\n      assertNoReservedBind(options.bind);\r\n    }\r\n\r\n    options = { ...options };\r\n\r\n    options.type = QueryTypes.UPSERT;\r\n    options.updateOnDuplicate = Object.keys(updateValues);\r\n    options.upsertKeys = Object.values(options.model.primaryKeys).map(item => item.field);\r\n\r\n    const model = options.model;\r\n    const { query, bind } = this.queryGenerator.insertQuery(tableName, insertValues, model.rawAttributes, options);\r\n\r\n    // unlike bind, replacements are handled by QueryGenerator, not QueryRaw\r\n    delete options.replacements;\r\n    options.bind = combineBinds(options.bind, bind);\r\n\r\n    return await this.sequelize.queryRaw(query, options);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  async removeConstraint(tableName, constraintName, options) {\r\n    const sql = this.queryGenerator.showConstraintsQuery(\r\n      tableName.tableName ? tableName : {\r\n        tableName,\r\n        schema: this.sequelize.config.database,\r\n      }, constraintName,\r\n    );\r\n\r\n    const constraints = await this.sequelize.queryRaw(sql, {\r\n      ...options,\r\n      type: this.sequelize.QueryTypes.SHOWCONSTRAINTS,\r\n    });\r\n\r\n    const constraint = constraints[0];\r\n    let query;\r\n    if (!constraint || !constraint.constraintType) {\r\n      throw new sequelizeErrors.UnknownConstraintError(\r\n        {\r\n          message: `Constraint ${constraintName} on table ${tableName} does not exist`,\r\n          constraint: constraintName,\r\n          table: tableName,\r\n        },\r\n      );\r\n    }\r\n\r\n    if (constraint.constraintType === 'FOREIGN KEY') {\r\n      query = this.queryGenerator.dropForeignKeyQuery(tableName, constraintName);\r\n    } else {\r\n      query = this.queryGenerator.removeIndexQuery(constraint.tableName, constraint.constraintName);\r\n    }\r\n\r\n    return await this.sequelize.queryRaw(query, options);\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,iBAAmD;AAEnD,MAAM,kBAAkB,QAAQ,cAAc;AAC9C,MAAM,EAAE,mBAAmB,QAAQ,6BAA6B;AAChE,MAAM,EAAE,eAAe,QAAQ,mBAAmB;AAK3C,MAAM,4BAA4B,eAAe;AAAA,QAMhD,aAAa,WAAW,YAAY,SAAS;AACjD,cAAU,WAAW,CAAC;AAEtB,UAAM,CAAC,WAAW,MAAM,KAAK,UAAU,SACrC,KAAK,eAAe,mBAAmB,UAAU,YAAY,YAAY;AAAA,MACvE;AAAA,MACA,QAAQ,KAAK,UAAU,OAAO;AAAA,IAChC,GAAG,UAAU,GACb,iBAAE,KAAK,QAAS,QAClB;AAGA,QAAI,QAAQ,SAAS,KAAK,QAAQ,GAAG,oBAAoB,WAAW;AAClE,YAAM,QAAQ,IAAI,QAAQ,IAAI,gBAAc,KAAK,UAAU,SACzD,KAAK,eAAe,oBAAoB,WAAW,WAAW,eAAe,GAC7E,iBAAE,KAAK,QAAS,QAClB,CAAC,CAAC;AAAA,IACJ;AAEA,WAAO,MAAM,KAAK,UAAU,SAC1B,KAAK,eAAe,kBAAkB,WAAW,UAAU,GAC3D,iBAAE,KAAK,QAAS,QAClB;AAAA,EACF;AAAA,QAKM,OAAO,WAAW,cAAc,cAAc,OAAO,SAAS;AAClE,QAAI,QAAQ,MAAM;AAChB,2CAAqB,QAAQ,IAAI;AAAA,IACnC;AAEA,cAAU,mBAAK;AAEf,YAAQ,OAAO,WAAW;AAC1B,YAAQ,oBAAoB,OAAO,KAAK,YAAY;AACpD,YAAQ,aAAa,OAAO,OAAO,QAAQ,MAAM,WAAW,EAAE,IAAI,UAAQ,KAAK,KAAK;AAEpF,UAAM,QAAQ,QAAQ;AACtB,UAAM,EAAE,OAAO,SAAS,KAAK,eAAe,YAAY,WAAW,cAAc,MAAM,eAAe,OAAO;AAG7G,WAAO,QAAQ;AACf,YAAQ,OAAO,6BAAa,QAAQ,MAAM,IAAI;AAE9C,WAAO,MAAM,KAAK,UAAU,SAAS,OAAO,OAAO;AAAA,EACrD;AAAA,QAKM,iBAAiB,WAAW,gBAAgB,SAAS;AACzD,UAAM,MAAM,KAAK,eAAe,qBAC9B,UAAU,YAAY,YAAY;AAAA,MAChC;AAAA,MACA,QAAQ,KAAK,UAAU,OAAO;AAAA,IAChC,GAAG,cACL;AAEA,UAAM,cAAc,MAAM,KAAK,UAAU,SAAS,KAAK,iCAClD,UADkD;AAAA,MAErD,MAAM,KAAK,UAAU,WAAW;AAAA,IAClC,EAAC;AAED,UAAM,aAAa,YAAY;AAC/B,QAAI;AACJ,QAAI,CAAC,cAAc,CAAC,WAAW,gBAAgB;AAC7C,YAAM,IAAI,gBAAgB,uBACxB;AAAA,QACE,SAAS,cAAc,2BAA2B;AAAA,QAClD,YAAY;AAAA,QACZ,OAAO;AAAA,MACT,CACF;AAAA,IACF;AAEA,QAAI,WAAW,mBAAmB,eAAe;AAC/C,cAAQ,KAAK,eAAe,oBAAoB,WAAW,cAAc;AAAA,IAC3E,OAAO;AACL,cAAQ,KAAK,eAAe,iBAAiB,WAAW,WAAW,WAAW,cAAc;AAAA,IAC9F;AAEA,WAAO,MAAM,KAAK,UAAU,SAAS,OAAO,OAAO;AAAA,EACrD;AACF;",
  "names": []
}
