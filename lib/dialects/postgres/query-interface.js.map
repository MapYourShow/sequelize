{
  "version": 3,
  "sources": ["../../../src/dialects/postgres/query-interface.js"],
  "sourcesContent": ["'use strict';\r\n\r\nconst DataTypes = require('../../data-types');\r\nconst { QueryTypes } = require('../../query-types');\r\nconst { QueryInterface } = require('../abstract/query-interface');\r\nconst Utils = require('../../utils');\r\n\r\n/**\r\n * The interface that Sequelize uses to talk with Postgres database\r\n */\r\nexport class PostgresQueryInterface extends QueryInterface {\r\n  /**\r\n   * Ensure enum and their values.\r\n   *\r\n   * @param {string} tableName  Name of table to create\r\n   * @param {object} attributes Object representing a list of normalized table attributes\r\n   * @param {object} [options]\r\n   * @param {Model}  [model]\r\n   *\r\n   * @protected\r\n   */\r\n  async ensureEnums(tableName, attributes, options, model) {\r\n    const keys = Object.keys(attributes);\r\n    const keyLen = keys.length;\r\n\r\n    let sql = '';\r\n    let promises = [];\r\n    let i = 0;\r\n\r\n    for (i = 0; i < keyLen; i++) {\r\n      const attribute = attributes[keys[i]];\r\n      const type = attribute.type;\r\n\r\n      if (\r\n        type instanceof DataTypes.ENUM\r\n        || type instanceof DataTypes.ARRAY && type.type instanceof DataTypes.ENUM // ARRAY sub type is ENUM\r\n      ) {\r\n        sql = this.queryGenerator.pgListEnums(tableName, attribute.field || keys[i], options);\r\n        promises.push(this.sequelize.queryRaw(\r\n          sql,\r\n          { ...options, plain: true, raw: true, type: QueryTypes.SELECT },\r\n        ));\r\n      }\r\n    }\r\n\r\n    const results = await Promise.all(promises);\r\n    promises = [];\r\n    let enumIdx = 0;\r\n\r\n    // This little function allows us to re-use the same code that prepends or appends new value to enum array\r\n    const addEnumValue = (field, value, relativeValue, position = 'before', spliceStart = promises.length) => {\r\n      const valueOptions = { ...options };\r\n      valueOptions.before = null;\r\n      valueOptions.after = null;\r\n\r\n      switch (position) {\r\n        case 'after':\r\n          valueOptions.after = relativeValue;\r\n          break;\r\n        case 'before':\r\n        default:\r\n          valueOptions.before = relativeValue;\r\n          break;\r\n      }\r\n\r\n      promises.splice(spliceStart, 0, () => {\r\n        return this.sequelize.queryRaw(this.queryGenerator.pgEnumAdd(\r\n          tableName, field, value, valueOptions,\r\n        ), valueOptions);\r\n      });\r\n    };\r\n\r\n    for (i = 0; i < keyLen; i++) {\r\n      const attribute = attributes[keys[i]];\r\n      const type = attribute.type;\r\n      const enumType = type.type || type;\r\n      const field = attribute.field || keys[i];\r\n\r\n      if (\r\n        type instanceof DataTypes.ENUM\r\n        || type instanceof DataTypes.ARRAY && enumType instanceof DataTypes.ENUM // ARRAY sub type is ENUM\r\n      ) {\r\n        // If the enum type doesn't exist then create it\r\n        if (!results[enumIdx]) {\r\n          promises.push(() => {\r\n            return this.sequelize.queryRaw(this.queryGenerator.pgEnum(tableName, field, enumType, options), { ...options, raw: true });\r\n          });\r\n        } else if (Boolean(results[enumIdx]) && Boolean(model)) {\r\n          const enumVals = this.queryGenerator.fromArray(results[enumIdx].enum_value);\r\n          const vals = enumType.values;\r\n\r\n          // Going through already existing values allows us to make queries that depend on those values\r\n          // We will prepend all new values between the old ones, but keep in mind - we can't change order of already existing values\r\n          // Then we append the rest of new values AFTER the latest already existing value\r\n          // E.g.: [1,2] -> [0,2,1] ==> [1,0,2]\r\n          // E.g.: [1,2,3] -> [2,1,3,4] ==> [1,2,3,4]\r\n          // E.g.: [1] -> [0,2,3] ==> [1,0,2,3]\r\n          let lastOldEnumValue;\r\n          let rightestPosition = -1;\r\n          for (let oldIndex = 0; oldIndex < enumVals.length; oldIndex++) {\r\n            const enumVal = enumVals[oldIndex];\r\n            const newIdx = vals.indexOf(enumVal);\r\n            lastOldEnumValue = enumVal;\r\n\r\n            if (newIdx === -1) {\r\n              continue;\r\n            }\r\n\r\n            const newValuesBefore = vals.slice(0, newIdx);\r\n            const promisesLength = promises.length;\r\n            // we go in reverse order so we could stop when we meet old value\r\n            for (let reverseIdx = newValuesBefore.length - 1; reverseIdx >= 0; reverseIdx--) {\r\n              if (~enumVals.indexOf(newValuesBefore[reverseIdx])) {\r\n                break;\r\n              }\r\n\r\n              addEnumValue(field, newValuesBefore[reverseIdx], lastOldEnumValue, 'before', promisesLength);\r\n            }\r\n\r\n            // we detect the most 'right' position of old value in new enum array so we can append new values to it\r\n            if (newIdx > rightestPosition) {\r\n              rightestPosition = newIdx;\r\n            }\r\n          }\r\n\r\n          if (lastOldEnumValue && rightestPosition < vals.length - 1) {\r\n            const remainingEnumValues = vals.slice(rightestPosition + 1);\r\n            for (let reverseIdx = remainingEnumValues.length - 1; reverseIdx >= 0; reverseIdx--) {\r\n              addEnumValue(field, remainingEnumValues[reverseIdx], lastOldEnumValue, 'after');\r\n            }\r\n          }\r\n\r\n          enumIdx++;\r\n        }\r\n      }\r\n    }\r\n\r\n    const result = await promises\r\n      .reduce(async (promise, asyncFunction) => await asyncFunction(await promise), Promise.resolve());\r\n\r\n    // If ENUM processed, then refresh OIDs\r\n    if (promises.length > 0) {\r\n      await this.sequelize.dialect.connectionManager._refreshDynamicOIDs();\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  async getForeignKeyReferencesForTable(table, options) {\r\n    const queryOptions = {\r\n      ...options,\r\n      type: QueryTypes.FOREIGNKEYS,\r\n    };\r\n\r\n    // postgres needs some special treatment as those field names returned are all lowercase\r\n    // in order to keep same result with other dialects.\r\n    const query = this.queryGenerator.getForeignKeyReferencesQuery(table.tableName || table, this.sequelize.config.database);\r\n    const result = await this.sequelize.queryRaw(query, queryOptions);\r\n\r\n    return result.map(Utils.camelizeObjectKeys);\r\n  }\r\n\r\n  /**\r\n   * Drop specified enum from database (Postgres only)\r\n   *\r\n   * @param {string} [enumName]  Enum name to drop\r\n   * @param {object} options Query options\r\n   *\r\n   * @returns {Promise}\r\n   */\r\n  async dropEnum(enumName, options) {\r\n    options = options || {};\r\n\r\n    return this.sequelize.queryRaw(\r\n      this.queryGenerator.pgEnumDrop(null, null, this.queryGenerator.pgEscapeAndQuote(enumName)),\r\n      { ...options, raw: true },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Drop all enums from database (Postgres only)\r\n   *\r\n   * @param {object} options Query options\r\n   *\r\n   * @returns {Promise}\r\n   */\r\n  async dropAllEnums(options) {\r\n    options = options || {};\r\n\r\n    const enums = await this.pgListEnums(null, options);\r\n\r\n    return await Promise.all(enums.map(result => this.sequelize.queryRaw(\r\n      this.queryGenerator.pgEnumDrop(null, null, this.queryGenerator.pgEscapeAndQuote(result.enum_name)),\r\n      { ...options, raw: true },\r\n    )));\r\n  }\r\n\r\n  /**\r\n   * List all enums (Postgres only)\r\n   *\r\n   * @param {string} [tableName]  Table whose enum to list\r\n   * @param {object} [options]    Query options\r\n   *\r\n   * @returns {Promise}\r\n   */\r\n  async pgListEnums(tableName, options) {\r\n    options = options || {};\r\n    const sql = this.queryGenerator.pgListEnums(tableName);\r\n\r\n    return this.sequelize.queryRaw(sql, { ...options, plain: false, raw: true, type: QueryTypes.SELECT });\r\n  }\r\n\r\n  /**\r\n   * Since postgres has a special case for enums, we should drop the related\r\n   * enum type within the table and attribute\r\n   *\r\n   * @override\r\n   */\r\n  async dropTable(tableName, options) {\r\n    await super.dropTable(tableName, options);\r\n    const promises = [];\r\n    const instanceTable = this.sequelize.modelManager.getModel(tableName, { attribute: 'tableName' });\r\n\r\n    if (!instanceTable) {\r\n      // Do nothing when model is not available\r\n      return;\r\n    }\r\n\r\n    const getTableName = (!options || !options.schema || options.schema === 'public' ? '' : `${options.schema}_`) + tableName;\r\n\r\n    const keys = Object.keys(instanceTable.rawAttributes);\r\n    const keyLen = keys.length;\r\n\r\n    for (let i = 0; i < keyLen; i++) {\r\n      if (instanceTable.rawAttributes[keys[i]].type instanceof DataTypes.ENUM) {\r\n        const sql = this.queryGenerator.pgEnumDrop(getTableName, keys[i]);\r\n        options.supportsSearchPath = false;\r\n        promises.push(this.sequelize.queryRaw(sql, { ...options, raw: true }));\r\n      }\r\n    }\r\n\r\n    await Promise.all(promises);\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
