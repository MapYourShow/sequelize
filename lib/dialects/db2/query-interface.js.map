{
  "version": 3,
  "sources": ["../../../src/dialects/db2/query-interface.js"],
  "sourcesContent": ["'use strict';\r\n\r\nimport { assertNoReservedBind } from '../../utils/sql';\r\n\r\nconst _ = require('lodash');\r\nconst Utils = require('../../utils');\r\nconst { Op } = require('../../operators');\r\nconst { QueryInterface } = require('../abstract/query-interface');\r\nconst { QueryTypes } = require('../../query-types');\r\n\r\n/**\r\n * The interface that Sequelize uses to talk with Db2 database\r\n */\r\nexport class Db2QueryInterface extends QueryInterface {\r\n  async getForeignKeyReferencesForTable(tableName, options) {\r\n    const queryOptions = {\r\n      ...options,\r\n      type: QueryTypes.FOREIGNKEYS,\r\n    };\r\n    const query = this.queryGenerator.getForeignKeysQuery(tableName, this.sequelize.config.username.toUpperCase());\r\n\r\n    return this.sequelize.queryRaw(query, queryOptions);\r\n  }\r\n\r\n  async upsert(tableName, insertValues, updateValues, where, options) {\r\n    if (options.bind) {\r\n      assertNoReservedBind(options.bind);\r\n    }\r\n\r\n    options = { ...options };\r\n\r\n    const model = options.model;\r\n    const wheres = [];\r\n    const attributes = Object.keys(insertValues);\r\n    let indexFields;\r\n\r\n    options = _.clone(options);\r\n\r\n    if (!Utils.isWhereEmpty(where)) {\r\n      wheres.push(where);\r\n    }\r\n\r\n    // Lets combine unique keys and indexes into one\r\n    const indexes = _.map(model.uniqueKeys, value => {\r\n      return value.fields;\r\n    });\r\n\r\n    for (const value of model._indexes) {\r\n      if (value.unique) {\r\n        // fields in the index may both the strings or objects with an attribute property - lets sanitize that\r\n        indexFields = value.fields.map(field => {\r\n          if (_.isPlainObject(field)) {\r\n            return field.attribute;\r\n          }\r\n\r\n          return field;\r\n        });\r\n        indexes.push(indexFields);\r\n      }\r\n    }\r\n\r\n    for (const index of indexes) {\r\n      if (_.intersection(attributes, index).length === index.length) {\r\n        where = {};\r\n        for (const field of index) {\r\n          where[field] = insertValues[field];\r\n        }\r\n\r\n        wheres.push(where);\r\n      }\r\n    }\r\n\r\n    where = { [Op.or]: wheres };\r\n\r\n    options.type = QueryTypes.UPSERT;\r\n    options.raw = true;\r\n\r\n    const sql = this.queryGenerator.upsertQuery(tableName, insertValues, updateValues, where, model, options);\r\n\r\n    delete options.replacements;\r\n\r\n    const result = await this.sequelize.queryRaw(sql, options);\r\n\r\n    return [result, undefined];\r\n  }\r\n\r\n  async createTable(tableName, attributes, options, model) {\r\n    let sql = '';\r\n\r\n    options = { ...options };\r\n\r\n    if (options && options.uniqueKeys) {\r\n      _.forOwn(options.uniqueKeys, uniqueKey => {\r\n        if (uniqueKey.customIndex === undefined) {\r\n          uniqueKey.customIndex = true;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (model) {\r\n      options.uniqueKeys = options.uniqueKeys || model.uniqueKeys;\r\n    }\r\n\r\n    attributes = _.mapValues(\r\n      attributes,\r\n      attribute => this.sequelize.normalizeAttribute(attribute),\r\n    );\r\n    if (options.indexes) {\r\n      for (const fields of options.indexes) {\r\n        const fieldArr = fields.fields;\r\n        if (fieldArr.length === 1) {\r\n          for (const field of fieldArr) {\r\n            for (const property in attributes) {\r\n              if (field === attributes[property].field) {\r\n                attributes[property].unique = true;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (options.alter && options.indexes) {\r\n      for (const fields of options.indexes) {\r\n        const fieldArr = fields.fields;\r\n        if (fieldArr.length === 1) {\r\n          for (const field of fieldArr) {\r\n            for (const property in attributes) {\r\n              if (field === attributes[property].field && attributes[property].unique) {\r\n                attributes[property].unique = false;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (\r\n      !tableName.schema\r\n      && (options.schema || Boolean(model) && model._schema)\r\n    ) {\r\n      tableName = this.queryGenerator.addSchema({\r\n        tableName,\r\n        _schema: Boolean(model) && model._schema || options.schema,\r\n      });\r\n    }\r\n\r\n    attributes = this.queryGenerator.attributesToSQL(attributes, { table: tableName, context: 'createTable' });\r\n    sql = this.queryGenerator.createTableQuery(tableName, attributes, options);\r\n\r\n    return await this.sequelize.queryRaw(sql, options);\r\n  }\r\n\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
